<script>
    /*
        [
            {
                "file_name": "FILE",
                "cdn_url": "CDN_URL",
                "peer_info": "PEER_INFO"       
            }
        ]
    */

    // REPLACED BY SERVER
    /////////////////////////////////////////////////////////////
    const peer_params = "PEER_PARAMS"
    /////////////////////////////////////////////////////////////

    const setup_rtc_offer = async () => {

        let peer_connection = new RTCPeerConnection();

        return (await peer_connection.createOffer())

    }

    const register_peer = async (filename) => {

        let offer = await setup_rtc_offer();

        // Create WebSocket connection.
        const socket = new WebSocket('ws://localhost:5000');

        // Connection opened
        socket.addEventListener('open', function (event) {
            socket.send(JSON.stringify({
                type: "peer_register",
                body: {
                    rtc_config: offer,
                    files: [filename]
                }
            }));
        });

        // Listen for messages
        socket.addEventListener('message', function (event) {
            console.log('Message from server ', event.data);
        });
    }

    const load_cdn_image = (image_loc, file_name) => {
        // "rtc_cdn_" is the prefix for document ids
        let cdn_image = document.getElementById("rtc_cdn_" + file_name);
        let cdn_speed_text = document.getElementById("speed_text");

        let start_time = new Date();

        cdn_image.onload = () => {
            cdn_speed_text.innerText = "4.0 mb loaded in " + (new Date() - start_time) + " ms";

            register_peer(file_name);
        }

        cdn_image.src = image_loc;
    }

    const load_rtc_image = () => {

    }

    window.addEventListener('DOMContentLoaded', (event) => {

        let p2p_files = [];

        Object.keys(peer_params).forEach((filename) => {
            // if no peer for file, load over cdn
            if (Object.keys(peer_params[filename].peers).length == 0) {
                document.getElementById("rtc_status").innerText = "Image loaded over CDN. Open a new tab to get it peer to peer";

                p2p_files.push()

                load_cdn_image(peer_params[filename].cdn_url, filename);
            }
            // else load over web rtc
            else {
                document.getElementById("rtc_status").innerText = "Image loaded over P2P!";
                load_rtc_image();
            }
        })

    });
</script>

<body>
    <h1>Web RTC CDN Benchmarker</h1>
    <p id="rtc_status"></p>
    <img id="rtc_cdn_test_file" width="580px" />
    <p id="speed_text"></p>
</body>

<style>
    body {
        padding: 10%;
        font-family: Arial, Helvetica, sans-serif
    }
</style>